package com.tw ter.ho _m xer.product.for_ 

 mport com.tw ter.ho _m xer.funct onal_component.decorator.bu lder.Ho Cl entEvent nfoBu lder
 mport com.tw ter.ho _m xer.funct onal_component.decorator.bu lder.Ho Conversat onModule tadataBu lder
 mport com.tw ter.ho _m xer.funct onal_component.decorator.bu lder.Ho T  l nesScore nfoBu lder
 mport com.tw ter.ho _m xer.funct onal_component.decorator.urt.bu lder.Ho FeedbackAct on nfoBu lder
 mport com.tw ter.ho _m xer.funct onal_component.decorator.urt.bu lder.Ho T etSoc alContextBu lder
 mport com.tw ter.ho _m xer.funct onal_component.feature_hydrator. nNetworkFeatureHydrator
 mport com.tw ter.ho _m xer.funct onal_component.feature_hydrator.Na sFeatureHydrator
 mport com.tw ter.ho _m xer.funct onal_component.feature_hydrator.Perspect veF lteredSoc alContextFeatureHydrator
 mport com.tw ter.ho _m xer.funct onal_component.feature_hydrator.SGSVal dSoc alContextFeatureHydrator
 mport com.tw ter.ho _m xer.funct onal_component.feature_hydrator.T etyp eFeatureHydrator
 mport com.tw ter.ho _m xer.funct onal_component.f lter.FeedbackFat gueF lter
 mport com.tw ter.ho _m xer.funct onal_component.f lter. nval dConversat onModuleF lter
 mport com.tw ter.ho _m xer.funct onal_component.f lter. nval dSubscr pt onT etF lter
 mport com.tw ter.ho _m xer.funct onal_component.f lter.RejectT etFromV e rF lter
 mport com.tw ter.ho _m xer.funct onal_component.f lter.Ret etDedupl cat onF lter
 mport com.tw ter.ho _m xer.funct onal_component.scorer.FeedbackFat gueScorer
 mport com.tw ter.ho _m xer.funct onal_component.scorer.OONT etScal ngScorer
 mport com.tw ter.ho _m xer.marshaller.t  l nes.Dev ceContextMarshaller
 mport com.tw ter.ho _m xer.marshaller.t  l nes.T  l neServ ceCursorMarshaller
 mport com.tw ter.ho _m xer.model.Ho Features.Conversat onModuleFocalT et dFeature
 mport com.tw ter.ho _m xer.model.Ho Features. nNetworkFeature
 mport com.tw ter.ho _m xer.model.Ho Features. sHydratedFeature
 mport com.tw ter.ho _m xer.model.Ho Features. sNsfwFeature
 mport com.tw ter.ho _m xer.model.Ho Features.QuotedT etDroppedFeature
 mport com.tw ter.ho _m xer.model.Ho Features.T  l neServ ceT etsFeature
 mport com.tw ter.ho _m xer.model.request.Dev ceContext
 mport com.tw ter.ho _m xer.product.for_ .feature_hydrator.FocalT etFeatureHydrator
 mport com.tw ter.ho _m xer.product.for_ .f lter.Soc alContextF lter
 mport com.tw ter.ho _m xer.product.for_ .model.For Query
 mport com.tw ter.ho _m xer.product.for_ .param.For Param.EnableT  l neScorerCand dateP pel neParam
 mport com.tw ter.ho _m xer.serv ce.Ho M xerAlertConf g
 mport com.tw ter.product_m xer.component_l brary.cand date_s ce.t  l ne_scorer.ScoredT etCand dateW hFocalT et
 mport com.tw ter.product_m xer.component_l brary.cand date_s ce.t  l ne_scorer.T  l neScorerCand dateS ce
 mport com.tw ter.product_m xer.component_l brary.decorator.urt.Urt emCand dateDecorator
 mport com.tw ter.product_m xer.component_l brary.decorator.urt.UrtMult pleModulesDecorator
 mport com.tw ter.product_m xer.component_l brary.decorator.urt.bu lder. em.t et.T etCand dateUrt emBu lder
 mport com.tw ter.product_m xer.component_l brary.decorator.urt.bu lder.t  l ne_module.ManualModule d
 mport com.tw ter.product_m xer.component_l brary.decorator.urt.bu lder.t  l ne_module.Stat cModuleD splayTypeBu lder
 mport com.tw ter.product_m xer.component_l brary.decorator.urt.bu lder.t  l ne_module.T  l neModuleBu lder
 mport com.tw ter.product_m xer.component_l brary.f lter.FeatureF lter
 mport com.tw ter.product_m xer.component_l brary.f lter.Pred cateFeatureF lter
 mport com.tw ter.product_m xer.component_l brary.model.cand date.T etCand date
 mport com.tw ter.product_m xer.core.funct onal_component.cand date_s ce.BaseCand dateS ce
 mport com.tw ter.product_m xer.core.funct onal_component.common.alert.Alert
 mport com.tw ter.product_m xer.core.funct onal_component.decorator.Cand dateDecorator
 mport com.tw ter.product_m xer.core.funct onal_component.feature_hydrator.BaseCand dateFeatureHydrator
 mport com.tw ter.product_m xer.core.funct onal_component.f lter.F lter
 mport com.tw ter.product_m xer.core.funct onal_component.scorer.Scorer
 mport com.tw ter.product_m xer.core.funct onal_component.transfor r.Cand dateFeatureTransfor r
 mport com.tw ter.product_m xer.core.funct onal_component.transfor r.Cand dateP pel neQueryTransfor r
 mport com.tw ter.product_m xer.core.funct onal_component.transfor r.Cand dateP pel neResultsTransfor r
 mport com.tw ter.product_m xer.core.model.common. dent f er.Cand dateP pel ne dent f er
 mport com.tw ter.product_m xer.core.model.common. dent f er.F lter dent f er
 mport com.tw ter.product_m xer.core.model.marshall ng.response.urt.EntryNa space
 mport com.tw ter.product_m xer.core.model.marshall ng.response.urt.t  l ne_module.Vert calConversat on
 mport com.tw ter.product_m xer.core.p pel ne.cand date.Cand dateP pel neConf g
 mport com.tw ter.t  l nes.conf gap .FSParam
 mport com.tw ter.t  l nes.model.cand date.Cand dateT etS ce d
 mport com.tw ter.t  l nes.serv ce.{thr ftscala => tst}
 mport com.tw ter.t  l nescorer.{thr ftscala => t}
 mport com.tw ter.t  l neserv ce.{thr ftscala => tlst}
 mport javax. nject. nject
 mport javax. nject.S ngleton

/**
 * Cand date P pel ne Conf g that fetc s t ets from t  T  l ne Scorer Cand date S ce
 */
@S ngleton
class For T  l neScorerCand dateP pel neConf g @ nject() (
  t  l neScorerCand dateS ce: T  l neScorerCand dateS ce,
  dev ceContextMarshaller: Dev ceContextMarshaller,
  t etyp eFeatureHydrator: T etyp eFeatureHydrator,
  sgsVal dSoc alContextFeatureHydrator: SGSVal dSoc alContextFeatureHydrator,
  perspect veF lteredSoc alContextFeatureHydrator: Perspect veF lteredSoc alContextFeatureHydrator,
  na sFeatureHydrator: Na sFeatureHydrator,
  focalT etFeatureHydrator: FocalT etFeatureHydrator,
   nval dSubscr pt onT etF lter:  nval dSubscr pt onT etF lter,
  ho FeedbackAct on nfoBu lder: Ho FeedbackAct on nfoBu lder,
  ho T etSoc alContextBu lder: Ho T etSoc alContextBu lder)
    extends Cand dateP pel neConf g[
      For Query,
      t.ScoredT etsRequest,
      ScoredT etCand dateW hFocalT et,
      T etCand date
    ] {

  overr de val  dent f er: Cand dateP pel ne dent f er =
    Cand dateP pel ne dent f er("For T  l neScorerT ets")

  pr vate val T etyp eHydratedF lter d = "T etyp eHydrated"
  pr vate val QuotedT etDroppedF lter d = "QuotedT etDropped"
  pr vate val OutOfNetworkNSFWF lter d = "OutOfNetworkNSFW"
  pr vate val Conversat onModuleNa space = EntryNa space("ho -conversat on")

  overr de val supportedCl entParam: Opt on[FSParam[Boolean]] =
    So (EnableT  l neScorerCand dateP pel neParam)

  overr de val cand dateS ce: BaseCand dateS ce[
    t.ScoredT etsRequest,
    ScoredT etCand dateW hFocalT et
  ] = t  l neScorerCand dateS ce

  overr de val queryTransfor r: Cand dateP pel neQueryTransfor r[
    For Query,
    t.ScoredT etsRequest
  ] = { query =>
    val dev ceContext = query.dev ceContext.getOrElse(Dev ceContext.Empty)

    val scoredT etsRequestContext = t.v1.ScoredT etsRequestContext(
      contextualUser d = query.cl entContext.user d,
      t  l ne d = query.cl entContext.user d.map(tlst.T  l ne d(tlst.T  l neType.Ho , _, None)),
      dev ceContext = So (dev ceContextMarshaller(dev ceContext, query.cl entContext)),
      seenT et ds = query.seenT et ds,
      contextualUserContext = So (tst.ContextualUserContext(query.cl entContext.userRoles)),
      t  l neRequestCursor = query.p pel neCursor.flatMap(T  l neServ ceCursorMarshaller(_))
    )

    val cand dateT etS ce ds = Seq(
      Cand dateT etS ce d.RecycledT et,
      Cand dateT etS ce d.Organ cT et,
      Cand dateT etS ce d.AncestorsOnlyOrgan cT et,
      Cand dateT etS ce d.Backf llOrgan cT et,
      Cand dateT etS ce d.CroonT et,
      Cand dateT etS ce d.Recom ndedT et,
      Cand dateT etS ce d.FrsT et,
      Cand dateT etS ce d.L stT et,
      Cand dateT etS ce d.Recom ndedTrendT et,
      Cand dateT etS ce d.PopularTop cT et
    )

    val t  l neServ ceT ets =
      query.features.map(_.getOrElse(T  l neServ ceT etsFeature, Seq.empty)).getOrElse(Seq.empty)

    val t  l neEntr es = t  l neServ ceT ets.map {  d =>
      tlst.T  l neEntry.T et(tlst.T et(status d =  d, sort ndex =  d))
    }

    t.ScoredT etsRequest.V1(
      t.v1.ScoredT etsRequest(
        scoredT etsRequestContext = So (scoredT etsRequestContext),
        cand dateT etS ce ds =
          So (cand dateT etS ce ds.flatMap(Cand dateT etS ce d.toThr ft)),
        maxResultsCount = query.requestedMaxResults,
        organ cT  l ne = So (
          tlst.T  l ne(
            t  l ne d = tlst.T  l ne d(
              t  l neType = tlst.T  l neType.Ho ,
               d = query.getRequ redUser d,
              canon calT  l ne d = None),
            entr es = t  l neEntr es,
            modules = tlst.T  l neModules()
          ))
      )
    )
  }

  overr de val featuresFromCand dateS ceTransfor rs: Seq[
    Cand dateFeatureTransfor r[ScoredT etCand dateW hFocalT et]
  ] = Seq(For T  l neScorerResponseFeatureTransfor r)

  overr de val resultTransfor r: Cand dateP pel neResultsTransfor r[
    ScoredT etCand dateW hFocalT et,
    T etCand date
  ] = { cand dateW hFocalT et d =>
    T etCand date( d = cand dateW hFocalT et d.cand date.t et d)
  }

  overr de val preF lterFeatureHydrat onPhase1: Seq[
    BaseCand dateFeatureHydrator[For Query, T etCand date, _]
  ] = Seq(
    na sFeatureHydrator,
    t etyp eFeatureHydrator,
     nNetworkFeatureHydrator,
    sgsVal dSoc alContextFeatureHydrator,
    perspect veF lteredSoc alContextFeatureHydrator,
  )

  overr de def f lters: Seq[F lter[For Query, T etCand date]] = Seq(
    Ret etDedupl cat onF lter,
    FeatureF lter.fromFeature(F lter dent f er(T etyp eHydratedF lter d),  sHydratedFeature),
    Pred cateFeatureF lter.fromPred cate(
      F lter dent f er(QuotedT etDroppedF lter d),
      shouldKeepCand date = { features => !features.getOrElse(QuotedT etDroppedFeature, false) }
    ),
    Pred cateFeatureF lter.fromPred cate(
      F lter dent f er(OutOfNetworkNSFWF lter d),
      shouldKeepCand date = { features =>
        features.getOrElse( nNetworkFeature, false) ||
        !features.getOrElse( sNsfwFeature, false)
      }
    ),
    FeedbackFat gueF lter,
    RejectT etFromV e rF lter,
    Soc alContextF lter,
     nval dSubscr pt onT etF lter,
     nval dConversat onModuleF lter
  )

  overr de val postF lterFeatureHydrat on: Seq[
    BaseCand dateFeatureHydrator[For Query, T etCand date, _]
  ] = Seq(focalT etFeatureHydrator)

  overr de val scorers: Seq[Scorer[For Query, T etCand date]] =
    Seq(OONT etScal ngScorer, FeedbackFat gueScorer)

  overr de val decorator: Opt on[Cand dateDecorator[For Query, T etCand date]] = {
    val cl entEvent nfoBu lder = Ho Cl entEvent nfoBu lder()

    val t et emBu lder = T etCand dateUrt emBu lder(
      cl entEvent nfoBu lder = cl entEvent nfoBu lder,
      soc alContextBu lder = So (ho T etSoc alContextBu lder),
      t  l nesScore nfoBu lder = So (Ho T  l nesScore nfoBu lder),
      feedbackAct on nfoBu lder = So (ho FeedbackAct on nfoBu lder)
    )

    val t etDecorator = Urt emCand dateDecorator(t et emBu lder)

    val moduleBu lder = T  l neModuleBu lder(
      entryNa space = Conversat onModuleNa space,
      cl entEvent nfoBu lder = cl entEvent nfoBu lder,
      module dGenerat on = ManualModule d(0L),
      d splayTypeBu lder = Stat cModuleD splayTypeBu lder(Vert calConversat on),
       tadataBu lder = So (Ho Conversat onModule tadataBu lder())
    )

    So (
      UrtMult pleModulesDecorator(
        urt emCand dateDecorator = t etDecorator,
        moduleBu lder = moduleBu lder,
        groupByKey = (_, _, cand dateFeatures) =>
          cand dateFeatures.getOrElse(Conversat onModuleFocalT et dFeature, None)
      ))
  }

  overr de val alerts: Seq[Alert] = Seq(
    Ho M xerAlertConf g.Bus nessH s.defaultSuccessRateAlert(),
    Ho M xerAlertConf g.Bus nessH s.defaultEmptyResponseRateAlert(10, 20)
  )
}
