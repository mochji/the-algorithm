package com.tw ter.ho _m xer.product.for_ 

 mport com.tw ter.cl entapp.{thr ftscala => ca}
 mport com.tw ter.goldf nch.ap .Ads nject onSurfaceAreas
 mport com.tw ter.ho _m xer.cand date_p pel ne.Ed edT etsCand dateP pel neConf g
 mport com.tw ter.ho _m xer.cand date_p pel ne.NewT etsP llCand dateP pel neConf g
 mport com.tw ter.ho _m xer.funct onal_component.decorator.urt.bu lder.AddEntr esW hReplaceAndShowAlertAndCover nstruct onBu lder
 mport com.tw ter.ho _m xer.funct onal_component.feature_hydrator._
 mport com.tw ter.ho _m xer.funct onal_component.selector.DebunchCand dates
 mport com.tw ter.ho _m xer.funct onal_component.selector.UpdateConversat onModule d
 mport com.tw ter.ho _m xer.funct onal_component.selector.UpdateHo Cl entEventDeta ls
 mport com.tw ter.ho _m xer.funct onal_component.selector.UpdateNewT etsP llDecorat on
 mport com.tw ter.ho _m xer.funct onal_component.s de_effect._
 mport com.tw ter.ho _m xer.model.ClearCac  nclude nstruct on
 mport com.tw ter.ho _m xer.model.Ho Features. nNetworkFeature
 mport com.tw ter.ho _m xer.param.Ho GlobalParams.MaxNumberReplace nstruct onsParam
 mport com.tw ter.ho _m xer.param.Ho M xerFlagNa .Scr beCl entEventsFlag
 mport com.tw ter.ho _m xer.product.follow ng.model.Ho M xerExternalStr ngs
 mport com.tw ter.ho _m xer.product.for_ .feature_hydrator.T  l neServ ceT etsQueryFeatureHydrator
 mport com.tw ter.ho _m xer.product.for_ .model.For Query
 mport com.tw ter.ho _m xer.product.for_ .param.For Param.ClearCac OnPtr
 mport com.tw ter.ho _m xer.product.for_ .param.For Param.EnableFl p nject onModuleCand dateP pel neParam
 mport com.tw ter.ho _m xer.product.for_ .param.For Param.Fl p nl ne nject onModulePos  on
 mport com.tw ter.ho _m xer.product.for_ .param.For Param.ServerMaxResultsParam
 mport com.tw ter.ho _m xer.product.for_ .param.For Param.T etPrev ewsPos  onParam
 mport com.tw ter.ho _m xer.product.for_ .param.For Param.WhoToFollowPos  onParam
 mport com.tw ter.ho _m xer.product.for_ .param.For Param.WhoToSubscr bePos  onParam
 mport com.tw ter.ho _m xer.product.for_ .s de_effect.ServedCand dateFeatureKeysKafkaS deEffectBu lder
 mport com.tw ter.ho _m xer.product.for_ .s de_effect.ServedCand dateKeysKafkaS deEffectBu lder
 mport com.tw ter.ho _m xer.product.for_ .s de_effect.ServedStatsS deEffect
 mport com.tw ter.ho _m xer.ut l.Cand datesUt l
 mport com.tw ter. nject.annotat ons.Flag
 mport com.tw ter.logp pel ne.cl ent.common.EventPubl s r
 mport com.tw ter.product_m xer.component_l brary.feature_hydrator.query.async.AsyncQueryFeatureHydrator
 mport com.tw ter.product_m xer.component_l brary.feature_hydrator.query.soc al_graph.Prev ewCreatorsQueryFeatureHydrator
 mport com.tw ter.product_m xer.component_l brary.feature_hydrator.query.soc al_graph.SGSFollo dUsersQueryFeatureHydrator
 mport com.tw ter.product_m xer.component_l brary.model.cand date.T etCand date
 mport com.tw ter.product_m xer.component_l brary.p pel ne.cand date.flex ble_ nject on_p pel ne.Fl pPromptCand dateP pel neConf gBu lder
 mport com.tw ter.product_m xer.component_l brary.p pel ne.cand date.who_to_follow_module.WhoToFollowCand dateP pel neConf g
 mport com.tw ter.product_m xer.component_l brary.p pel ne.cand date.who_to_subscr be_module.WhoToSubscr beCand dateP pel neConf g
 mport com.tw ter.product_m xer.component_l brary.premarshaller.urt.UrtDoma nMarshaller
 mport com.tw ter.product_m xer.component_l brary.premarshaller.urt.bu lder.ClearCac  nstruct onBu lder
 mport com.tw ter.product_m xer.component_l brary.premarshaller.urt.bu lder.OrderedBottomCursorBu lder
 mport com.tw ter.product_m xer.component_l brary.premarshaller.urt.bu lder.OrderedTopCursorBu lder
 mport com.tw ter.product_m xer.component_l brary.premarshaller.urt.bu lder.ReplaceAllEntr es
 mport com.tw ter.product_m xer.component_l brary.premarshaller.urt.bu lder.ReplaceEntry nstruct onBu lder
 mport com.tw ter.product_m xer.component_l brary.premarshaller.urt.bu lder.ShowAlert nstruct onBu lder
 mport com.tw ter.product_m xer.component_l brary.premarshaller.urt.bu lder.ShowCover nstruct onBu lder
 mport com.tw ter.product_m xer.component_l brary.premarshaller.urt.bu lder.Stat cT  l neScr beConf gBu lder
 mport com.tw ter.product_m xer.component_l brary.premarshaller.urt.bu lder.Urt tadataBu lder
 mport com.tw ter.product_m xer.component_l brary.selector.DropMaxCand dates
 mport com.tw ter.product_m xer.component_l brary.selector.DropMaxModule emCand dates
 mport com.tw ter.product_m xer.component_l brary.selector.DropModuleTooFewModule emResults
 mport com.tw ter.product_m xer.component_l brary.selector. nsertAppendResults
 mport com.tw ter.product_m xer.component_l brary.selector. nsertF xedPos  onResults
 mport com.tw ter.product_m xer.component_l brary.selector.SelectCond  onally
 mport com.tw ter.product_m xer.component_l brary.selector.UpdateSortCand dates
 mport com.tw ter.product_m xer.component_l brary.selector.UpdateSortModule emCand dates
 mport com.tw ter.product_m xer.component_l brary.selector.ads.Ads njector
 mport com.tw ter.product_m xer.component_l brary.selector.ads. nsertAdResults
 mport com.tw ter.product_m xer.core.funct onal_component.common.Spec f cP pel ne
 mport com.tw ter.product_m xer.core.funct onal_component.common.Spec f cP pel nes
 mport com.tw ter.product_m xer.core.funct onal_component.conf gap .Stat cParam
 mport com.tw ter.product_m xer.core.funct onal_component.feature_hydrator.QueryFeatureHydrator
 mport com.tw ter.product_m xer.core.funct onal_component.marshaller.TransportMarshaller
 mport com.tw ter.product_m xer.core.funct onal_component.marshaller.response.urt.UrtTransportMarshaller
 mport com.tw ter.product_m xer.core.funct onal_component.premarshaller.Doma nMarshaller
 mport com.tw ter.product_m xer.core.funct onal_component.selector.Selector
 mport com.tw ter.product_m xer.core.funct onal_component.s de_effect.P pel neResultS deEffect
 mport com.tw ter.product_m xer.core.model.common.Un versalNoun
 mport com.tw ter.product_m xer.core.model.common. dent f er.Cand dateP pel ne dent f er
 mport com.tw ter.product_m xer.core.model.common. dent f er.M xerP pel ne dent f er
 mport com.tw ter.product_m xer.core.model.common.presentat on. emCand dateW hDeta ls
 mport com.tw ter.product_m xer.core.model.common.presentat on.ModuleCand dateW hDeta ls
 mport com.tw ter.product_m xer.core.model.marshall ng.response.urt.T  l ne
 mport com.tw ter.product_m xer.core.model.marshall ng.response.urt.T  l neModule
 mport com.tw ter.product_m xer.core.model.marshall ng.response.urt.T  l neScr beConf g
 mport com.tw ter.product_m xer.core.model.marshall ng.response.urt. em.t et.T et em
 mport com.tw ter.product_m xer.core.p pel ne.Fa lOpenPol cy
 mport com.tw ter.product_m xer.core.p pel ne.cand date.Cand dateP pel neConf g
 mport com.tw ter.product_m xer.core.p pel ne.cand date.DependentCand dateP pel neConf g
 mport com.tw ter.product_m xer.core.p pel ne.m xer.M xerP pel neConf g
 mport com.tw ter.product_m xer.core.product.gu ce.scope.ProductScoped
 mport com.tw ter.str ngcenter.cl ent.Str ngCenter
 mport com.tw ter.t  l nes.render.{thr ftscala => urt}
 mport javax. nject. nject
 mport javax. nject.Prov der
 mport javax. nject.S ngleton

@S ngleton
class For ScoredT etsM xerP pel neConf g @ nject() (
  for AdsDependentCand dateP pel neBu lder: For AdsDependentCand dateP pel neBu lder,
  for Conversat onServ ceCand dateP pel neConf g: For Conversat onServ ceCand dateP pel neConf g,
  for PushToHo T etCand dateP pel neConf g: For PushToHo T etCand dateP pel neConf g,
  for ScoredT etsCand dateP pel neConf g: For ScoredT etsCand dateP pel neConf g,
  for WhoToFollowCand dateP pel neConf gBu lder: For WhoToFollowCand dateP pel neConf gBu lder,
  for WhoToSubscr beCand dateP pel neConf gBu lder: For WhoToSubscr beCand dateP pel neConf gBu lder,
  fl pPromptCand dateP pel neConf gBu lder: Fl pPromptCand dateP pel neConf gBu lder,
  ed edT etsCand dateP pel neConf g: Ed edT etsCand dateP pel neConf g,
  newT etsP llCand dateP pel neConf g: NewT etsP llCand dateP pel neConf g[For Query],
  for T etPrev ewsCand dateP pel neConf g: For T etPrev ewsCand dateP pel neConf g,
  d sm ss nfoQueryFeatureHydrator: D sm ss nfoQueryFeatureHydrator,
  g zmoduckUserQueryFeatureHydrator: G zmoduckUserQueryFeatureHydrator,
  pers stenceStoreQueryFeatureHydrator: Pers stenceStoreQueryFeatureHydrator,
  requestQueryFeatureHydrator: RequestQueryFeatureHydrator[For Query],
  t  l neServ ceT etsQueryFeatureHydrator: T  l neServ ceT etsQueryFeatureHydrator,
  prev ewCreatorsQueryFeatureHydrator: Prev ewCreatorsQueryFeatureHydrator,
  sgsFollo dUsersQueryFeatureHydrator: SGSFollo dUsersQueryFeatureHydrator,
  ads njector: Ads njector,
  servedCand dateKeysKafkaS deEffectBu lder: ServedCand dateKeysKafkaS deEffectBu lder,
  servedCand dateFeatureKeysKafkaS deEffectBu lder: ServedCand dateFeatureKeysKafkaS deEffectBu lder,
  updateT  l nesPers stenceStoreS deEffect: UpdateT  l nesPers stenceStoreS deEffect,
  truncateT  l nesPers stenceStoreS deEffect: TruncateT  l nesPers stenceStoreS deEffect,
  ho Scr beServedCand datesS deEffect: Ho Scr beServedCand datesS deEffect,
  servedStatsS deEffect: ServedStatsS deEffect,
  cl entEventsScr beEventPubl s r: EventPubl s r[ca.LogEvent],
  externalStr ngs: Ho M xerExternalStr ngs,
  @ProductScoped str ngCenterProv der: Prov der[Str ngCenter],
  urtTransportMarshaller: UrtTransportMarshaller,
  @Flag(Scr beCl entEventsFlag) enableScr beCl entEvents: Boolean)
    extends M xerP pel neConf g[For Query, T  l ne, urt.T  l neResponse] {

  overr de val  dent f er: M xerP pel ne dent f er = M xerP pel ne dent f er("For ScoredT ets")

  pr vate val MaxConsecut veOutOfNetworkCand dates = 2

  pr vate val PushToHo T etPos  on = 0

  pr vate val dependentCand datesStep = M xerP pel neConf g.dependentCand dateP pel nesStep

  overr de val fetchQueryFeatures: Seq[QueryFeatureHydrator[For Query]] = Seq(
    requestQueryFeatureHydrator,
    pers stenceStoreQueryFeatureHydrator,
    t  l neServ ceT etsQueryFeatureHydrator,
    prev ewCreatorsQueryFeatureHydrator,
    sgsFollo dUsersQueryFeatureHydrator,
    AsyncQueryFeatureHydrator(dependentCand datesStep, d sm ss nfoQueryFeatureHydrator),
    AsyncQueryFeatureHydrator(dependentCand datesStep, g zmoduckUserQueryFeatureHydrator),
  )

  pr vate val scoredT etsCand dateP pel neScope =
    Spec f cP pel ne(for ScoredT etsCand dateP pel neConf g. dent f er)

  pr vate val for AdsCand dateP pel neConf g = for AdsDependentCand dateP pel neBu lder
    .bu ld(scoredT etsCand dateP pel neScope)

  pr vate val for WhoToFollowCand dateP pel neConf g =
    for WhoToFollowCand dateP pel neConf gBu lder.bu ld()

  pr vate val for WhoToSubscr beCand dateP pel neConf g =
    for WhoToSubscr beCand dateP pel neConf gBu lder.bu ld()

  pr vate val fl pPromptCand dateP pel neConf g =
    fl pPromptCand dateP pel neConf gBu lder.bu ld[For Query](
      supportedCl entParam = So (EnableFl p nject onModuleCand dateP pel neParam)
    )

  overr de val cand dateP pel nes: Seq[Cand dateP pel neConf g[For Query, _, _, _]] = Seq(
    for ScoredT etsCand dateP pel neConf g,
    for PushToHo T etCand dateP pel neConf g,
    for WhoToFollowCand dateP pel neConf g,
    for WhoToSubscr beCand dateP pel neConf g,
    for T etPrev ewsCand dateP pel neConf g,
    fl pPromptCand dateP pel neConf g
  )

  overr de val dependentCand dateP pel nes: Seq[
    DependentCand dateP pel neConf g[For Query, _, _, _]
  ] = Seq(
    for AdsCand dateP pel neConf g,
    for Conversat onServ ceCand dateP pel neConf g,
    ed edT etsCand dateP pel neConf g,
    newT etsP llCand dateP pel neConf g
  )

  overr de val fa lOpenPol c es: Map[Cand dateP pel ne dent f er, Fa lOpenPol cy] = Map(
    for ScoredT etsCand dateP pel neConf g. dent f er -> Fa lOpenPol cy.Always,
    for AdsCand dateP pel neConf g. dent f er -> Fa lOpenPol cy.Always,
    for WhoToFollowCand dateP pel neConf g. dent f er -> Fa lOpenPol cy.Always,
    for WhoToSubscr beCand dateP pel neConf g. dent f er -> Fa lOpenPol cy.Always,
    for T etPrev ewsCand dateP pel neConf g. dent f er -> Fa lOpenPol cy.Always,
    fl pPromptCand dateP pel neConf g. dent f er -> Fa lOpenPol cy.Always,
    ed edT etsCand dateP pel neConf g. dent f er -> Fa lOpenPol cy.Always,
    newT etsP llCand dateP pel neConf g. dent f er -> Fa lOpenPol cy.Always,
  )

  overr de val resultSelectors: Seq[Selector[For Query]] = Seq(
    UpdateSortCand dates(
      order ng = Cand datesUt l.reverseChronT etsOrder ng,
      cand dateP pel ne = for Conversat onServ ceCand dateP pel neConf g. dent f er
    ),
    UpdateSortCand dates(
      order ng = Cand datesUt l.scoreOrder ng,
      cand dateP pel ne = for ScoredT etsCand dateP pel neConf g. dent f er
    ),
    UpdateSortModule emCand dates(
      cand dateP pel ne = for ScoredT etsCand dateP pel neConf g. dent f er,
      order ng = Cand datesUt l.conversat onModuleT etsOrder ng
    ),
    DebunchCand dates(
      p pel neScope = Spec f cP pel ne(for ScoredT etsCand dateP pel neConf g. dent f er),
      mustDebunch = {
        case  em:  emCand dateW hDeta ls =>
          ! em.features.getOrElse( nNetworkFeature, false)
        case module: ModuleCand dateW hDeta ls =>
          !module.cand dates.last.features.getOrElse( nNetworkFeature, false)
      },
      maxBunchS ze = MaxConsecut veOutOfNetworkCand dates
    ),
    UpdateConversat onModule d(
      p pel neScope = Spec f cP pel ne(for ScoredT etsCand dateP pel neConf g. dent f er)
    ),
    DropMaxCand dates(
      cand dateP pel ne = for Conversat onServ ceCand dateP pel neConf g. dent f er,
      maxSelect onsParam = ServerMaxResultsParam
    ),
    DropMaxCand dates(
      cand dateP pel ne = for ScoredT etsCand dateP pel neConf g. dent f er,
      maxSelect onsParam = ServerMaxResultsParam
    ),
    DropMaxCand dates(
      cand dateP pel ne = ed edT etsCand dateP pel neConf g. dent f er,
      maxSelect onsParam = MaxNumberReplace nstruct onsParam
    ),
    DropMaxModule emCand dates(
      cand dateP pel ne = for WhoToFollowCand dateP pel neConf g. dent f er,
      maxModule emsParam = Stat cParam(WhoToFollowCand dateP pel neConf g.MaxCand datesS ze)
    ),
    DropMaxModule emCand dates(
      cand dateP pel ne = for WhoToSubscr beCand dateP pel neConf g. dent f er,
      maxModule emsParam = Stat cParam(WhoToSubscr beCand dateP pel neConf g.MaxCand datesS ze)
    ),
    // T  Conversat on Serv ce p pel ne w ll only run  f t  Scored T ets p pel ne returned noth ng
     nsertAppendResults(
      cand dateP pel ne = for Conversat onServ ceCand dateP pel neConf g. dent f er
    ),
     nsertAppendResults(
      cand dateP pel ne = for ScoredT etsCand dateP pel neConf g. dent f er
    ),
     nsertF xedPos  onResults(
      cand dateP pel ne = for T etPrev ewsCand dateP pel neConf g. dent f er,
      pos  onParam = T etPrev ewsPos  onParam
    ),
     nsertF xedPos  onResults(
      cand dateP pel ne = for WhoToFollowCand dateP pel neConf g. dent f er,
      pos  onParam = WhoToFollowPos  onParam
    ),
     nsertF xedPos  onResults(
      cand dateP pel ne = for WhoToSubscr beCand dateP pel neConf g. dent f er,
      pos  onParam = WhoToSubscr bePos  onParam
    ),
     nsertF xedPos  onResults(
      cand dateP pel ne = fl pPromptCand dateP pel neConf g. dent f er,
      pos  onParam = Fl p nl ne nject onModulePos  on
    ),
    //  nsert Push To Ho  T et at top of T  l ne
     nsertF xedPos  onResults(
      cand dateP pel ne = for PushToHo T etCand dateP pel neConf g. dent f er,
      pos  onParam = Stat cParam(PushToHo T etPos  on)
    ),
     nsertAdResults(
      surfaceAreaNa  = Ads nject onSurfaceAreas.Ho T  l ne,
      ads njector = ads njector.forSurfaceArea(Ads nject onSurfaceAreas.Ho T  l ne),
      adsCand dateP pel ne = for AdsCand dateP pel neConf g. dent f er
    ),
    // T  selector must co  after t  t ets are  nserted  nto t  results
    DropModuleTooFewModule emResults(
      cand dateP pel ne = for WhoToFollowCand dateP pel neConf g. dent f er,
      m nModule emsParam = Stat cParam(WhoToFollowCand dateP pel neConf g.M nCand datesS ze)
    ),
    DropModuleTooFewModule emResults(
      cand dateP pel ne = for WhoToSubscr beCand dateP pel neConf g. dent f er,
      m nModule emsParam = Stat cParam(WhoToSubscr beCand dateP pel neConf g.M nCand datesS ze)
    ),
    UpdateNewT etsP llDecorat on(
      p pel neScope = Spec f cP pel nes(
        for Conversat onServ ceCand dateP pel neConf g. dent f er,
        for ScoredT etsCand dateP pel neConf g. dent f er,
        newT etsP llCand dateP pel neConf g. dent f er
      ),
      str ngCenter = str ngCenterProv der.get(),
      seeNewT etsStr ng = externalStr ngs.seeNewT etsStr ng,
      t etedStr ng = externalStr ngs.t etedStr ng
    ),
     nsertAppendResults(cand dateP pel ne = ed edT etsCand dateP pel neConf g. dent f er),
    SelectCond  onally(
      selector =
         nsertAppendResults(cand dateP pel ne = newT etsP llCand dateP pel neConf g. dent f er),
       ncludeSelector = (_, _, results) => Cand datesUt l.conta nsType[T etCand date](results)
    ),
    UpdateHo Cl entEventDeta ls(
      cand dateP pel nes = Set(
        for Conversat onServ ceCand dateP pel neConf g. dent f er,
        for ScoredT etsCand dateP pel neConf g. dent f er
      )
    ),
  )

  pr vate val servedCand dateKeysKafkaS deEffect =
    servedCand dateKeysKafkaS deEffectBu lder.bu ld(
      Set(for ScoredT etsCand dateP pel neConf g. dent f er))

  pr vate val servedCand dateFeatureKeysKafkaS deEffect =
    servedCand dateFeatureKeysKafkaS deEffectBu lder.bu ld(
      Set(for ScoredT etsCand dateP pel neConf g. dent f er))

  pr vate val ho Scr beCl entEventS deEffect = Ho Scr beCl entEventS deEffect(
    enableScr beCl entEvents = enableScr beCl entEvents,
    logP pel nePubl s r = cl entEventsScr beEventPubl s r,
     njectedT etsCand dateP pel ne dent f ers = Seq(
      for ScoredT etsCand dateP pel neConf g. dent f er,
      for Conversat onServ ceCand dateP pel neConf g. dent f er
    ),
    adsCand dateP pel ne dent f er = So (for AdsCand dateP pel neConf g. dent f er),
    whoToFollowCand dateP pel ne dent f er = So (
      for WhoToFollowCand dateP pel neConf g. dent f er
    ),
    whoToSubscr beCand dateP pel ne dent f er =
      So (for WhoToSubscr beCand dateP pel neConf g. dent f er)
  )

  overr de val resultS deEffects: Seq[P pel neResultS deEffect[For Query, T  l ne]] = Seq(
    servedCand dateKeysKafkaS deEffect,
    servedCand dateFeatureKeysKafkaS deEffect,
    updateT  l nesPers stenceStoreS deEffect,
    truncateT  l nesPers stenceStoreS deEffect,
    ho Scr beCl entEventS deEffect,
    ho Scr beServedCand datesS deEffect,
    servedStatsS deEffect
  )

  overr de val doma nMarshaller: Doma nMarshaller[For Query, T  l ne] = {
    val  nstruct onBu lders = Seq(
      ClearCac  nstruct onBu lder(
        ClearCac  nclude nstruct on(
          ClearCac OnPtr.EnableParam,
          ClearCac OnPtr.M nEntr esParam,
        )
      ),
      ReplaceEntry nstruct onBu lder(ReplaceAllEntr es),
      // excludes alert, cover, and replace cand dates
      AddEntr esW hReplaceAndShowAlertAndCover nstruct onBu lder(),
      ShowAlert nstruct onBu lder(),
      ShowCover nstruct onBu lder(),
    )

    val  dSelector: Part alFunct on[Un versalNoun[_], Long] = {
      // exclude ads wh le determ n ng t et cursor values
      case  em: T et em  f  em.promoted tadata. sEmpty =>  em. d
      case module: T  l neModule
           f module. ems. adOpt on.ex sts(_. em. s nstanceOf[T et em]) =>
        module. ems.last. em match { case  em: T et em =>  em. d }
    }
    val topCursorBu lder = OrderedTopCursorBu lder( dSelector)
    val bottomCursorBu lder = OrderedBottomCursorBu lder( dSelector)

    val  tadataBu lder = Urt tadataBu lder(
      t le = None,
      scr beConf gBu lder = So (
        Stat cT  l neScr beConf gBu lder(
          T  l neScr beConf g(
            page = So ("for_ _scored_t ets"),
            sect on = None,
            ent yToken = None)))
    )

    UrtDoma nMarshaller(
       nstruct onBu lders =  nstruct onBu lders,
       tadataBu lder = So ( tadataBu lder),
      cursorBu lders = Seq(topCursorBu lder, bottomCursorBu lder)
    )
  }

  overr de val transportMarshaller: TransportMarshaller[T  l ne, urt.T  l neResponse] =
    urtTransportMarshaller
}
